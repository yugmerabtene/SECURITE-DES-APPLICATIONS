# TP-01 — Inscription / Connexion sécurisées (Django)

**Énoncé**

## 1) Objectifs

* Mettre en œuvre un module **Register / Login** conforme au **modèle CIA** (Confidentialité, Intégrité, Disponibilité).
* Se prémunir contre les menaces majeures de l’**OWASP Top 10** (A01, A02, A03, A05, A06, A07, A09).
* Intégrer des protections **anti-brute force** (throttling / lockout) et **anti-enumeration**.
* Produire des **tests**, des **logs**, et une **documentation de sécurité**.

## 2) Contexte

Vous développez un mini-site Django avec pages **/register**, **/login**, **/logout** et une page protégée **/dashboard** accessible uniquement après authentification. L’exercice se fait en environnement de développement, mais la configuration devra être **production-ready** (paramètres de sécurité en place et documentés).

## 3) Périmètre fonctionnel attendu

* **Register**

  * Champs : `email` (unique), `username`, `password1`, `password2`, case à cocher “CGU”.
  * Politique de mot de passe robuste (voir exigences).
  * Validation serveur systématique, messages d’erreur génériques (pas d’info sur l’existence d’un compte).
* **Login**

  * Authentification par `username` **ou** `email`.
  * Messages d’erreur **non révélateurs** (anti-enumeration).
  * Après X essais échoués, verrouillage temporaire (throttling/lockout).
* **Logout**

  * Invalidation de session.
* **Dashboard**

  * Protégé par authentification, affichage d’un message de bienvenue sans divulgation de données sensibles.

## 4) Exigences de sécurité (obligatoires)

1. **Gestion des secrets et de l’environnement**

   * Clé `SECRET_KEY` chargée depuis un fichier `.env` (ex. `django-environ`).
   * `DEBUG=False` pour la configuration “production” et `ALLOWED_HOSTS` défini.
2. **Chiffrement et mots de passe (A02)**

   * `PASSWORD_HASHERS` inclut **Argon2** (ou PBKDF2 a minima).
   * Politiques de mot de passe via `AUTH_PASSWORD_VALIDATORS` (longueur, complexité, historique non requis).
3. **CSRF / XSS (A03/A05)**

   * CSRF actif sur tous les POST (formulaires).
   * Templates auto-escaped ; aucune interpolation non échappée.
4. **Contrôle d’accès (A01)**

   * Accès au **/dashboard** uniquement pour utilisateurs authentifiés.
   * Décorateurs ou mixins (`@login_required`).
5. **Brute force & enumeration (A07)**

   * **Throttling** de login : ex. max 5 essais/15 min par IP et par identifiant.
   * Message d’erreur unique (“Identifiants invalides”) quel que soit le cas.
6. **Sécurité des cookies & session**

   * `SESSION_COOKIE_SECURE=True`, `SESSION_COOKIE_HTTPONLY=True`, `SESSION_COOKIE_SAMESITE='Lax'` (ou `Strict` selon votre choix).
   * `CSRF_COOKIE_SECURE=True`, `CSRF_COOKIE_SAMESITE='Lax'`.
7. **Headers de sécurité (A05)**

   * `SECURE_SSL_REDIRECT=True` (à documenter pour prod), `SECURE_HSTS_SECONDS` (activable en prod), `X_FRAME_OPTIONS='DENY'`, `SECURE_REFERRER_POLICY='strict-origin-when-cross-origin'`.
8. **Dépendances (A06)**

   * Gel des versions (`requirements.txt`), vérification avec `pip-audit` ou `safety`.
9. **Journaux et monitoring (A09)**

   * Journaliser au minimum : tentatives de login, lockouts, création de compte, logout.
   * Rotation de logs ou fichier dédié `auth.log`.
10. **ORM uniquement (A03)**

    * Aucune requête SQL brute pour l’authentification/inscription.

## 5) Exigences de sécurité (optionnelles mais recommandées – bonus)

* **Validation d’adresse email** (lien de confirmation, jeton).
* **2FA/MFA** (TOTP) sur la connexion.
* **Honeypot** sur le formulaire d’inscription.
* **Rate limiting** global d’IP sur toutes les vues sensibles.
* **Captcha** après N échecs.

## 6) Attaques à simuler et résultats attendus

* **Brute force** sur /login : au-delà du seuil, l’IP/le compte est **temporairement bloqué**.
* **User enumeration** : tester emails/identifiants inexistants ; le message reste **générique**.
* **Injection** dans les champs : aucune exécution, l’ORM et la validation bloquent.
* **CSRF** : soumission sans jeton → **rejetée**.
* **XSS** : saisie de `<script>` dans `username` → rendu **échappé** côté template.

## 7) Contraintes techniques

* **Python ≥ 3.10**, **Django ≥ 4.2 LTS**.
* Application `accounts/` dédiée.
* Si vous étendez l’utilisateur, utilisez `AbstractUser` avec `AUTH_USER_MODEL`.
* Structure de paramètres recommandée : `settings/base.py`, `settings/dev.py`, `settings/prod.py`.
* Fichier `.env.example` fourni (jamais committer `.env` réel).

## 8) Tests attendus (minimum)

* Inscription : succès, mots de passe non conformes, email déjà pris.
* Connexion : succès, échec, lockout après N échecs.
* Accès au dashboard : redirection si non authentifié.
* XSS : rendu échappé.
* CSRF : POST sans jeton refusé.

## 9) Livrables

1. **Code source** du projet (Git) avec :

   * `accounts/`, `templates/`, `requirements.txt`, `README.md`, `.env.example`.
2. **Document de sécurité** (PDF, 2–4 pages) :

   * Tableau **CIA** appliqué au module auth.
   * Mappage des contrôles aux **OWASP Top 10** (A01, A02, A03, A05, A06, A07, A09).
   * Description du **throttling** (seuils choisis, périmètre IP/compte, durée).
3. **Journal de tests** (texte) : scénarios d’attaque et résultats.

**Nom du dépôt/zip** : `prenom_nom_TP-01_auth_django.zip`
**Nom du rapport** : `prenom_nom_TP-01_rapport.pdf`

## 10) Barème (sur 20)

* Fonctionnel Register/Login/Logout : **4 pts**
* Contrôles d’accès & anti-enumeration : **3 pts**
* CSRF/XSS/ORM (A03/A05) : **3 pts**
* Throttling / Lockout anti-brute force : **3 pts**
* Cookies & headers sécurité : **2 pts**
* Dépendances et logs : **2 pts**
* Tests automatisés : **2 pts**
* Documentation sécurité (CIA + OWASP mapping) : **1 pt**

## 11) Conseils de réalisation

* Commencez par le **fonctionnel**, puis activez les **protections** une à une.
* Tenez un **journal** des décisions (seuils, réglages).
* Testez avec un navigateur privé et avec un outil de requêtes (curl/httpie).
* Gardez des messages d’erreur **neutres** côté Login.
